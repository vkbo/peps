
<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PEP 500 – A protocol for delegating datetime methods to their
tzinfo implementations | peps.python.org</title>
    <link rel="shortcut icon" href="../_static/py.png"/>
    <link rel="stylesheet" href="../_static/style.css" type="text/css" />
    <link rel="stylesheet" href="../_static/mq.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <meta name="description" content="Python Enhancement Proposals (PEPs)"/>
</head>
<body>
    <section id="pep-page-section">
        <header>
            <h1>Python Enhancement Proposals</h1>
            <ul class="breadcrumbs">
                <li><a href="https://www.python.org/" title="The Python Programming Language">Python</a> &raquo; </li>
                <li><a href="../pep-0000/">PEP Index</a> &raquo; </li>
                <li>PEP 500 – A protocol for delegating datetime methods to their
tzinfo implementations</li>
            </ul>
        </header>
        <article>
            <section id="pep-content">
<h1 class="page-title">PEP 500 – A protocol for delegating datetime methods to their
tzinfo implementations</h1>
<dl class="rfc2822 field-list simple">
<dt class="field-odd">PEP</dt>
<dd class="field-odd">500</dd>
<dt class="field-even">Title</dt>
<dd class="field-even">A protocol for delegating datetime methods to their
tzinfo implementations</dd>
<dt class="field-odd">Author</dt>
<dd class="field-odd">Alexander Belopolsky &lt;alexander.belopolsky&#32;&#97;t&#32;gmail.com&gt;, Tim Peters &lt;tim.peters&#32;&#97;t&#32;gmail.com&gt;</dd>
<dt class="field-even">Discussions-To</dt>
<dd class="field-even">Datetime-SIG &lt;<a class="reference external" href="mailto:datetime-sig&#37;&#52;&#48;python&#46;org?subject=PEP%20500">datetime-sig&#32;&#97;t&#32;python.org</a>&gt;</dd>
<dt class="field-odd">Status</dt>
<dd class="field-odd">Rejected</dd>
<dt class="field-even">Type</dt>
<dd class="field-even">Standards Track</dd>
<dt class="field-odd">Requires</dt>
<dd class="field-odd"><a class="reference external" href="../pep-0495">495</a></dd>
<dt class="field-even">Created</dt>
<dd class="field-even">08-Aug-2015</dd>
<dt class="field-odd">Resolution</dt>
<dd class="field-odd"><a class="reference external" href="https://mail.python.org/pipermail/datetime-sig/2015-August/000354.html">https://mail.python.org/pipermail/datetime-sig/2015-August/000354.html</a></dd>
</dl>
<hr class="docutils" />
<section id="contents">
<h2>Contents</h2>
<ul class="simple">
<li><a class="reference internal" href="#abstract">Abstract</a></li>
<li><a class="reference internal" href="#rationale">Rationale</a></li>
<li><a class="reference internal" href="#protocol">Protocol</a><ul>
<li><a class="reference internal" href="#subtraction-of-datetime">Subtraction of datetime</a></li>
<li><a class="reference internal" href="#addition">Addition</a></li>
<li><a class="reference internal" href="#subtraction-of-timedelta">Subtraction of timedelta</a></li>
<li><a class="reference internal" href="#formatting">Formatting</a></li>
<li><a class="reference internal" href="#parsing">Parsing</a></li>
</ul>
</li>
<li><a class="reference internal" href="#changes-to-datetime-methods">Changes to datetime methods</a><ul>
<li><a class="reference internal" href="#subtraction">Subtraction</a></li>
<li><a class="reference internal" href="#id1">Addition</a></li>
</ul>
</li>
<li><a class="reference internal" href="#strict-arithmetics">Strict arithmetics</a><ul>
<li><a class="reference internal" href="#parsing-and-formatting">Parsing and formatting</a></li>
</ul>
</li>
<li><a class="reference internal" href="#applications">Applications</a></li>
<li><a class="reference internal" href="#copyright">Copyright</a></li>
</ul>
</section>
<section id="abstract">
<h2><a class="toc-backref" href="#abstract">Abstract</a></h2>
<p>This PEP specifies a new protocol (PDDM - “A Protocol for Delegating
Datetime Methods”) that can be used by concrete implementations of the
<code class="docutils literal notranslate"><span class="pre">datetime.tzinfo</span></code> interface to override aware datetime arithmetics,
formatting and parsing.  We describe changes to the
<code class="docutils literal notranslate"><span class="pre">datetime.datetime</span></code> class to support the new protocol and propose a
new abstract class <code class="docutils literal notranslate"><span class="pre">datetime.tzstrict</span></code> that implements parts of this
protocol necessary to make aware datetime instances to follow “strict”
arithmetic rules.</p>
</section>
<section id="rationale">
<h2><a class="toc-backref" href="#rationale">Rationale</a></h2>
<p>As of Python 3.5, aware datetime instances that share a <code class="docutils literal notranslate"><span class="pre">tzinfo</span></code>
object follow the rules of arithmetics that are induced by a simple
bijection between (year, month, day, hour, minute, second,
microsecond) 7-tuples and large integers.  In this arithmetics, the
difference between YEAR-11-02T12:00 and YEAR-11-01T12:00 is always 24
hours, even though in the US/Eastern timezone, for example, there are
25 hours between 2014-11-01T12:00 and 2014-11-02T12:00 because the
local clocks were rolled back one hour at 2014-11-02T02:00,
introducing an extra hour in the night between 2014-11-01 and
2014-11-02.</p>
<p>Many business applications require the use of Python’s simplified view
of local dates.  No self-respecting car rental company will charge its
customers more for a week that straddles the end of DST than for any
other week or require that they return the car an hour early.
Therefore, changing the current rules for aware datetime arithmetics
will not only create a backward compatibility nightmare, it will
eliminate support for legitimate and common use cases.</p>
<p>Since it is impossible to choose universal rules for local time
arithmetics, we propose to delegate implementation of those rules to
the classes that implement <code class="docutils literal notranslate"><span class="pre">datetime.tzinfo</span></code> interface.  With such
delegation in place, users will be able to choose between different
arithmetics by simply picking instances of different classes for the
value of <code class="docutils literal notranslate"><span class="pre">tzinfo</span></code>.</p>
</section>
<section id="protocol">
<h2><a class="toc-backref" href="#protocol">Protocol</a></h2>
<section id="subtraction-of-datetime">
<h3><a class="toc-backref" href="#subtraction-of-datetime">Subtraction of datetime</a></h3>
<p>A <code class="docutils literal notranslate"><span class="pre">tzinfo</span></code> subclass supporting the PDDM, may define a method called
<code class="docutils literal notranslate"><span class="pre">__datetime_diff__</span></code> that should take two <code class="docutils literal notranslate"><span class="pre">datetime.datetime</span></code>
instances and return a <code class="docutils literal notranslate"><span class="pre">datetime.timedelta</span></code> instance representing
the time elapsed from the time represented by the first datetime
instance to another.</p>
</section>
<section id="addition">
<h3><a class="toc-backref" href="#addition">Addition</a></h3>
<p>A <code class="docutils literal notranslate"><span class="pre">tzinfo</span></code> subclass supporting the PDDM, may define a method called
<code class="docutils literal notranslate"><span class="pre">__datetime_add__</span></code> that should take two arguments–a datetime and a
timedelta instances–and return a datetime instance.</p>
</section>
<section id="subtraction-of-timedelta">
<h3><a class="toc-backref" href="#subtraction-of-timedelta">Subtraction of timedelta</a></h3>
<p>A <code class="docutils literal notranslate"><span class="pre">tzinfo</span></code> subclass supporting the PDDM, may define a method called
<code class="docutils literal notranslate"><span class="pre">__datetime_sub__</span></code> that should take two arguments–a datetime and a
timedelta instances–and return a datetime instance.</p>
</section>
<section id="formatting">
<h3><a class="toc-backref" href="#formatting">Formatting</a></h3>
<p>A <code class="docutils literal notranslate"><span class="pre">tzinfo</span></code> subclass supporting the PDDM, may define methods called
<code class="docutils literal notranslate"><span class="pre">__datetime_isoformat__</span></code> and <code class="docutils literal notranslate"><span class="pre">__datetime_strftime__</span></code>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">__datetime_isoformat__</span></code> method should take a datetime instance
and an optional separator and produce a string representation of the
given datetime instance.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">__datetime_strftime__</span></code> method should take a datetime instance
and a format string and produce a string representation of the given
datetime instance formatted according to the given format.</p>
</section>
<section id="parsing">
<h3><a class="toc-backref" href="#parsing">Parsing</a></h3>
<p>A <code class="docutils literal notranslate"><span class="pre">tzinfo</span></code> subclass supporting the PDDM, may define a class method
called <code class="docutils literal notranslate"><span class="pre">__datetime_strptime__</span></code> and register the “canonical” names of
the timezones that it implements with a registry. <strong>TODO</strong> Describe a
registry.</p>
</section>
</section>
<section id="changes-to-datetime-methods">
<h2><a class="toc-backref" href="#changes-to-datetime-methods">Changes to datetime methods</a></h2>
<section id="subtraction">
<h3><a class="toc-backref" href="#subtraction">Subtraction</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">datetime</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__sub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">datetime</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">self_diff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tzinfo</span><span class="o">.</span><span class="n">__datetime_diff__</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="n">self_diff</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">other_diff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tzinfo</span><span class="o">.</span><span class="n">__datetime_diff__</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="n">other_diff</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">self_diff</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">self_diff</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">other_diff</span> <span class="ow">and</span> <span class="n">self_diff</span><span class="o">.</span><span class="vm">__func__</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">other_diff</span><span class="o">.</span><span class="vm">__func__</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot find difference of two datetimes with &quot;</span>
                                     <span class="s2">&quot;different tzinfo.__datetime_diff__ implementations.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">self_diff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">sub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tzinfo</span><span class="o">.</span><span class="n">__datetime_sub__</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">sub</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span> <span class="o">+</span> <span class="o">-</span><span class="n">other</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">NotImplemented</span>
        <span class="c1"># current implementation</span>
</pre></div>
</div>
</section>
<section id="id1">
<h3><a class="toc-backref" href="#id1">Addition</a></h3>
<p>Addition of a timedelta to a datetime instance will be delegated to the
<code class="docutils literal notranslate"><span class="pre">self.tzinfo.__datetime_add__</span></code> method whenever it is defined.</p>
</section>
</section>
<section id="strict-arithmetics">
<h2><a class="toc-backref" href="#strict-arithmetics">Strict arithmetics</a></h2>
<p>A new abstract subclass of <code class="docutils literal notranslate"><span class="pre">datetime.tzinfo</span></code> class called  <code class="docutils literal notranslate"><span class="pre">datetime.tzstrict</span></code>
will be added to the <code class="docutils literal notranslate"><span class="pre">datetime</span></code> module.  This subclass will not implement the
<code class="docutils literal notranslate"><span class="pre">utcoffset()</span></code>, <code class="docutils literal notranslate"><span class="pre">tzname()</span></code> or <code class="docutils literal notranslate"><span class="pre">dst()</span></code> methods, but will implement some of the
methods of the PDDM.</p>
<p>The PDDM methods implemented by <code class="docutils literal notranslate"><span class="pre">tzstrict</span></code> will be equivalent to the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">tzstrict</span><span class="p">(</span><span class="n">tzinfo</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__datetime_diff__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt1</span><span class="p">,</span> <span class="n">dt2</span><span class="p">):</span>
        <span class="n">utc_dt1</span> <span class="o">=</span> <span class="n">dt1</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
        <span class="n">utc_dt2</span> <span class="o">=</span> <span class="n">dt2</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">utc_dt2</span> <span class="o">-</span> <span class="n">utc_dt1</span>

    <span class="k">def</span> <span class="nf">__datetime_add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">delta</span><span class="p">):</span>
        <span class="n">utc_dt</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">utc_dt</span> <span class="o">+</span> <span class="n">delta</span><span class="p">)</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__datetime_sub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">delta</span><span class="p">):</span>
        <span class="n">utc_dt</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">utc_dt</span> <span class="o">-</span> <span class="n">delta</span><span class="p">)</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</pre></div>
</div>
<section id="parsing-and-formatting">
<h3><a class="toc-backref" href="#parsing-and-formatting">Parsing and formatting</a></h3>
<p>Datetime methods <code class="docutils literal notranslate"><span class="pre">strftime</span></code> and <code class="docutils literal notranslate"><span class="pre">isoformat</span></code> will delegate to the namesake
methods of their <code class="docutils literal notranslate"><span class="pre">tzinfo</span></code> members whenever those methods are defined.</p>
<p>When the <code class="docutils literal notranslate"><span class="pre">datetime.strptime</span></code> method is given a format string that
contains a <code class="docutils literal notranslate"><span class="pre">%Z</span></code> instruction, it will lookup the <code class="docutils literal notranslate"><span class="pre">tzinfo</span></code>
implementation in the registry by the given timezone name and call its
<code class="docutils literal notranslate"><span class="pre">__datetime_strptime__</span></code> method.</p>
</section>
</section>
<section id="applications">
<h2><a class="toc-backref" href="#applications">Applications</a></h2>
<p>This PEP will enable third party implementation of many different
timekeeping schemes including:</p>
<ul class="simple">
<li>Julian / Microsoft Excel calendar.</li>
<li>“Right” timezones with the leap second support.</li>
<li>French revolutionary calendar (with a lot of work).</li>
</ul>
</section>
<section id="copyright">
<h2><a class="toc-backref" href="#copyright">Copyright</a></h2>
<p>This document has been placed in the public domain.</p>
</section>
</section>
<p>Source: <a class="reference external" href="https://github.com/python/peps/blob/master/pep-0500.txt">https://github.com/python/peps/blob/master/pep-0500.txt</a></p>
<p>Last modified: <a class="reference external" href="https://github.com/python/peps/commits/master/pep-0500.txt">2019-07-03 18:20:45 GMT</a></p>

        </article>
        <nav id="pep-sidebar">
            <h2>Contents</h2>
            <ul>
<li><a class="reference internal" href="#">PEP 500 – A protocol for delegating datetime methods to their
tzinfo implementations</a><ul>
<li><a class="reference internal" href="#contents">Contents</a></li>
<li><a class="reference internal" href="#abstract">Abstract</a></li>
<li><a class="reference internal" href="#rationale">Rationale</a></li>
<li><a class="reference internal" href="#protocol">Protocol</a><ul>
<li><a class="reference internal" href="#subtraction-of-datetime">Subtraction of datetime</a></li>
<li><a class="reference internal" href="#addition">Addition</a></li>
<li><a class="reference internal" href="#subtraction-of-timedelta">Subtraction of timedelta</a></li>
<li><a class="reference internal" href="#formatting">Formatting</a></li>
<li><a class="reference internal" href="#parsing">Parsing</a></li>
</ul>
</li>
<li><a class="reference internal" href="#changes-to-datetime-methods">Changes to datetime methods</a><ul>
<li><a class="reference internal" href="#subtraction">Subtraction</a></li>
<li><a class="reference internal" href="#id1">Addition</a></li>
</ul>
</li>
<li><a class="reference internal" href="#strict-arithmetics">Strict arithmetics</a><ul>
<li><a class="reference internal" href="#parsing-and-formatting">Parsing and formatting</a></li>
</ul>
</li>
<li><a class="reference internal" href="#applications">Applications</a></li>
<li><a class="reference internal" href="#copyright">Copyright</a></li>
</ul>
</li>
</ul>

            <br />
            <strong><a href="https://github.com/python/peps/blob/master/pep-0500.txt">Page Source (GitHub)</a></strong>
        </nav>
    </section>
    <script src="../_static/doctools.js"></script>
</body>
</html>